<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6.1 Instal·lar Truenass | Arts escèniques</title>
  <meta name="description" content="Projecte Asisx I.E. Maria Enriques" />
  <meta name="generator" content="bookdown 0.26 and GitBook 2.6.7" />

  <meta property="og:title" content="6.1 Instal·lar Truenass | Arts escèniques" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Projecte Asisx I.E. Maria Enriques" />
  <meta name="github-repo" content="incitato/prova" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6.1 Instal·lar Truenass | Arts escèniques" />
  
  <meta name="twitter:description" content="Projecte Asisx I.E. Maria Enriques" />
  

<meta name="author" content="Ramiro Palau Gregori" />


<meta name="date" content="2022-06-12" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="truenas.html"/>
<link rel="next" href="politaca-de-volums.html"/>
<script src="assets/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="assets/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="assets/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="assets/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="assets/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Arts esceniques</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>A proposit del treball</a>
<ul>
<li class="chapter" data-level="" data-path="propòsit.html"><a href="propòsit.html"><i class="fa fa-check"></i>Propòsit</a>
<ul>
<li class="chapter" data-level="" data-path="propòsit.html"><a href="propòsit.html#plan-b"><i class="fa fa-check"></i>Plan B</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="agraïments.html"><a href="agraïments.html"><i class="fa fa-check"></i>Agraïments</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="infraestructura.html"><a href="infraestructura.html"><i class="fa fa-check"></i><b>1</b> Infraestructura</a>
<ul>
<li class="chapter" data-level="1.1" data-path="xarxa-per-a-la-sala.html"><a href="xarxa-per-a-la-sala.html"><i class="fa fa-check"></i><b>1.1</b> Xarxa per a la sala</a></li>
<li class="chapter" data-level="1.2" data-path="descripció-de-les-installacions.html"><a href="descripció-de-les-installacions.html"><i class="fa fa-check"></i><b>1.2</b> Descripció de les instal·lacions</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="descripció-de-les-installacions.html"><a href="descripció-de-les-installacions.html#oficina"><i class="fa fa-check"></i><b>1.2.1</b> Oficina</a></li>
<li class="chapter" data-level="1.2.2" data-path="descripció-de-les-installacions.html"><a href="descripció-de-les-installacions.html#sala-despera"><i class="fa fa-check"></i><b>1.2.2</b> Sala d’espera</a></li>
<li class="chapter" data-level="1.2.3" data-path="descripció-de-les-installacions.html"><a href="descripció-de-les-installacions.html#escenari"><i class="fa fa-check"></i><b>1.2.3</b> Escenari</a></li>
<li class="chapter" data-level="1.2.4" data-path="descripció-de-les-installacions.html"><a href="descripció-de-les-installacions.html#rebost"><i class="fa fa-check"></i><b>1.2.4</b> Rebost</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="descripció-de-les-xarxes.html"><a href="descripció-de-les-xarxes.html"><i class="fa fa-check"></i><b>1.3</b> Descripció de les xarxes</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="descripció-de-les-xarxes.html"><a href="descripció-de-les-xarxes.html#vlan-1-administració"><i class="fa fa-check"></i><b>1.3.1</b> VLAN 1 Administració</a></li>
<li class="chapter" data-level="1.3.2" data-path="descripció-de-les-xarxes.html"><a href="descripció-de-les-xarxes.html#vlan-20-privat"><i class="fa fa-check"></i><b>1.3.2</b> VLAN 20 Privat</a></li>
<li class="chapter" data-level="1.3.3" data-path="descripció-de-les-xarxes.html"><a href="descripció-de-les-xarxes.html#vlan-30-video"><i class="fa fa-check"></i><b>1.3.3</b> VLAN 30 Video</a></li>
<li class="chapter" data-level="1.3.4" data-path="descripció-de-les-xarxes.html"><a href="descripció-de-les-xarxes.html#vlan-40-pública"><i class="fa fa-check"></i><b>1.3.4</b> VLAN 40 pública</a></li>
<li class="chapter" data-level="1.3.5" data-path="descripció-de-les-xarxes.html"><a href="descripció-de-les-xarxes.html#xarxa-interna-dels-serveis"><i class="fa fa-check"></i><b>1.3.5</b> Xarxa interna dels serveis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="proposta-de-projecte.html"><a href="proposta-de-projecte.html"><i class="fa fa-check"></i><b>2</b> Proposta de projecte</a>
<ul>
<li class="chapter" data-level="2.1" data-path="serveis-proposats.html"><a href="serveis-proposats.html"><i class="fa fa-check"></i><b>2.1</b> Serveis proposats</a></li>
<li class="chapter" data-level="2.2" data-path="pressupost-del-maquinari.html"><a href="pressupost-del-maquinari.html"><i class="fa fa-check"></i><b>2.2</b> Pressupost del maquinari</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="servidor.html"><a href="servidor.html"><i class="fa fa-check"></i><b>3</b> Servidor</a></li>
<li class="chapter" data-level="4" data-path="proxmox.html"><a href="proxmox.html"><i class="fa fa-check"></i><b>4</b> Proxmox</a>
<ul>
<li class="chapter" data-level="4.1" data-path="preliminars.html"><a href="preliminars.html"><i class="fa fa-check"></i><b>4.1</b> Preliminars</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="preliminars.html"><a href="preliminars.html#servidor-nfs-en-local"><i class="fa fa-check"></i><b>4.1.1</b> Servidor NFS en local</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="installacio-de-proxmox-en-una-vm-amb-kvm.html"><a href="installacio-de-proxmox-en-una-vm-amb-kvm.html"><i class="fa fa-check"></i><b>4.2</b> Instal·lacio de Proxmox en una VM amb KVM</a></li>
<li class="chapter" data-level="4.3" data-path="arranquem-la-installacio.html"><a href="arranquem-la-installacio.html"><i class="fa fa-check"></i><b>4.3</b> Arranquem la instal·lacio</a></li>
<li class="chapter" data-level="4.4" data-path="primeres-configuracions.html"><a href="primeres-configuracions.html"><i class="fa fa-check"></i><b>4.4</b> Primeres configuracions</a></li>
<li class="chapter" data-level="4.5" data-path="actualitzar-repositoris.html"><a href="actualitzar-repositoris.html"><i class="fa fa-check"></i><b>4.5</b> Actualitzar repositoris</a></li>
<li class="chapter" data-level="4.6" data-path="afegir-nous-hd-al-servidor.html"><a href="afegir-nous-hd-al-servidor.html"><i class="fa fa-check"></i><b>4.6</b> Afegir nous HD al servidor</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="afegir-nous-hd-al-servidor.html"><a href="afegir-nous-hd-al-servidor.html#procediment"><i class="fa fa-check"></i><b>4.6.1</b> Procediment</a></li>
<li class="chapter" data-level="4.6.2" data-path="afegir-nous-hd-al-servidor.html"><a href="afegir-nous-hd-al-servidor.html#configuracio-del-nou-ssd-per-a-les-vm"><i class="fa fa-check"></i><b>4.6.2</b> Configuracio del nou SSD per a les VM</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="afegir-lemmagatzenament-de-còpia-de-seguretat.html"><a href="afegir-lemmagatzenament-de-còpia-de-seguretat.html"><i class="fa fa-check"></i><b>4.7</b> Afegir l’emmagatzenament de còpia de seguretat</a></li>
<li class="chapter" data-level="4.8" data-path="crear-nova-vm.html"><a href="crear-nova-vm.html"><i class="fa fa-check"></i><b>4.8</b> Crear nova VM</a></li>
<li class="chapter" data-level="4.9" data-path="contenidors-lxc-en-proxmox.html"><a href="contenidors-lxc-en-proxmox.html"><i class="fa fa-check"></i><b>4.9</b> Contenidors LXC en Proxmox</a>
<ul>
<li class="chapter" data-level="4.9.1" data-path="contenidors-lxc-en-proxmox.html"><a href="contenidors-lxc-en-proxmox.html#distribucions-suportades"><i class="fa fa-check"></i><b>4.9.1</b> Distribucions suportades</a></li>
<li class="chapter" data-level="4.9.2" data-path="contenidors-lxc-en-proxmox.html"><a href="contenidors-lxc-en-proxmox.html#imatges-de-contenidors"><i class="fa fa-check"></i><b>4.9.2</b> Imatges de contenidors</a></li>
<li class="chapter" data-level="4.9.3" data-path="contenidors-lxc-en-proxmox.html"><a href="contenidors-lxc-en-proxmox.html#creem-una-ct-amb-la-imatge-que-acabem-de-baixar"><i class="fa fa-check"></i><b>4.9.3</b> Creem una CT amb la imatge que acabem de baixar</a></li>
</ul></li>
<li class="chapter" data-level="4.10" data-path="subxarxes-en-proxmox.html"><a href="subxarxes-en-proxmox.html"><i class="fa fa-check"></i><b>4.10</b> Subxarxes en Proxmox</a>
<ul>
<li class="chapter" data-level="4.10.1" data-path="subxarxes-en-proxmox.html"><a href="subxarxes-en-proxmox.html#segon-intercace-post-install"><i class="fa fa-check"></i><b>4.10.1</b> Segon intercace, post install</a></li>
</ul></li>
<li class="chapter" data-level="4.11" data-path="còpies-de-seguretat.html"><a href="còpies-de-seguretat.html"><i class="fa fa-check"></i><b>4.11</b> Còpies de seguretat</a>
<ul>
<li class="chapter" data-level="4.11.1" data-path="còpies-de-seguretat.html"><a href="còpies-de-seguretat.html#copia-de-seguretat-de-truena"><i class="fa fa-check"></i><b>4.11.1</b> Copia de seguretat de truena</a></li>
<li class="chapter" data-level="4.11.2" data-path="còpies-de-seguretat.html"><a href="còpies-de-seguretat.html#còpia-de-seguretat-de-proxmox"><i class="fa fa-check"></i><b>4.11.2</b> Còpia de seguretat de Proxmox</a></li>
<li class="chapter" data-level="4.11.3" data-path="còpies-de-seguretat.html"><a href="còpies-de-seguretat.html#pve-zsync"><i class="fa fa-check"></i><b>4.11.3</b> pve-zsync</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="pfsense.html"><a href="pfsense.html"><i class="fa fa-check"></i><b>5</b> pfSense</a>
<ul>
<li class="chapter" data-level="5.1" data-path="per-a-què-el-farem-servir.html"><a href="per-a-què-el-farem-servir.html"><i class="fa fa-check"></i><b>5.1</b> Per a què el farem servir</a></li>
<li class="chapter" data-level="5.2" data-path="requeriments.html"><a href="requeriments.html"><i class="fa fa-check"></i><b>5.2</b> Requeriments</a></li>
<li class="chapter" data-level="5.3" data-path="installació.html"><a href="installació.html"><i class="fa fa-check"></i><b>5.3</b> Instal·lació</a></li>
<li class="chapter" data-level="5.4" data-path="configuració.html"><a href="configuració.html"><i class="fa fa-check"></i><b>5.4</b> Configuració</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="configuració.html"><a href="configuració.html#informació-general"><i class="fa fa-check"></i><b>5.4.1</b> Informació general</a></li>
<li class="chapter" data-level="5.4.2" data-path="configuració.html"><a href="configuració.html#configuració-wan"><i class="fa fa-check"></i><b>5.4.2</b> Configuració WAN</a></li>
<li class="chapter" data-level="5.4.3" data-path="configuració.html"><a href="configuració.html#configuració-lan"><i class="fa fa-check"></i><b>5.4.3</b> Configuració LAN</a></li>
<li class="chapter" data-level="5.4.4" data-path="configuració.html"><a href="configuració.html#configuració-de-les-vlan"><i class="fa fa-check"></i><b>5.4.4</b> Configuració de les VLAN</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="configuració-dns.html"><a href="configuració-dns.html"><i class="fa fa-check"></i><b>5.5</b> Configuració DNS</a></li>
<li class="chapter" data-level="5.6" data-path="firewall.html"><a href="firewall.html"><i class="fa fa-check"></i><b>5.6</b> Firewall</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="firewall.html"><a href="firewall.html#vlan-1"><i class="fa fa-check"></i><b>5.6.1</b> VLAN 1</a></li>
<li class="chapter" data-level="5.6.2" data-path="firewall.html"><a href="firewall.html#vlan-20"><i class="fa fa-check"></i><b>5.6.2</b> VLAN 20</a></li>
<li class="chapter" data-level="5.6.3" data-path="firewall.html"><a href="firewall.html#vlan-30-soles-interna-no-internet"><i class="fa fa-check"></i><b>5.6.3</b> VLAN 30 soles interna, no internet</a></li>
<li class="chapter" data-level="5.6.4" data-path="firewall.html"><a href="firewall.html#vlan-40-soles-internet"><i class="fa fa-check"></i><b>5.6.4</b> VLAN 40 Soles internet</a></li>
<li class="chapter" data-level="5.6.5" data-path="firewall.html"><a href="firewall.html#lan"><i class="fa fa-check"></i><b>5.6.5</b> LAN</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="dns-dinàmic.html"><a href="dns-dinàmic.html"><i class="fa fa-check"></i><b>5.7</b> DNS dinàmic</a>
<ul>
<li class="chapter" data-level="5.7.1" data-path="dns-dinàmic.html"><a href="dns-dinàmic.html#renovacions-del-servei"><i class="fa fa-check"></i><b>5.7.1</b> Renovacions del servei</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="vpn.html"><a href="vpn.html"><i class="fa fa-check"></i><b>5.8</b> vpn</a>
<ul>
<li class="chapter" data-level="5.8.1" data-path="vpn.html"><a href="vpn.html#autenticació"><i class="fa fa-check"></i><b>5.8.1</b> Autenticació</a></li>
<li class="chapter" data-level="5.8.2" data-path="vpn.html"><a href="vpn.html#firewall-1"><i class="fa fa-check"></i><b>5.8.2</b> Firewall</a></li>
<li class="chapter" data-level="5.8.3" data-path="vpn.html"><a href="vpn.html#configuració-òptima-de-xifratge"><i class="fa fa-check"></i><b>5.8.3</b> Configuració òptima de xifratge</a></li>
<li class="chapter" data-level="5.8.4" data-path="vpn.html"><a href="vpn.html#udp"><i class="fa fa-check"></i><b>5.8.4</b> UDP</a></li>
<li class="chapter" data-level="5.8.5" data-path="vpn.html"><a href="vpn.html#utilitzeu-tls-només-per-a-lautenticació"><i class="fa fa-check"></i><b>5.8.5</b> Utilitzeu TLS només per a l’autenticació</a></li>
<li class="chapter" data-level="5.8.6" data-path="vpn.html"><a href="vpn.html#utilitzeu-la-negociació-de-xifratge-de-dades"><i class="fa fa-check"></i><b>5.8.6</b> Utilitzeu la negociació de xifratge de dades</a></li>
<li class="chapter" data-level="5.8.7" data-path="vpn.html"><a href="vpn.html#túnels-dividits"><i class="fa fa-check"></i><b>5.8.7</b> Túnels dividits</a></li>
<li class="chapter" data-level="5.8.8" data-path="vpn.html"><a href="vpn.html#desactiva-la-compressió"><i class="fa fa-check"></i><b>5.8.8</b> Desactiva la compressió</a></li>
<li class="chapter" data-level="5.8.9" data-path="vpn.html"><a href="vpn.html#connexions-duplicades"><i class="fa fa-check"></i><b>5.8.9</b> Connexions duplicades</a></li>
<li class="chapter" data-level="5.8.10" data-path="vpn.html"><a href="vpn.html#augmenta-la-memòria-intermèdia-denviamentrecepció"><i class="fa fa-check"></i><b>5.8.10</b> Augmenta la memòria intermèdia d’enviament/recepció</a></li>
<li class="chapter" data-level="5.8.11" data-path="vpn.html"><a href="vpn.html#openvpn-i-certificats"><i class="fa fa-check"></i><b>5.8.11</b> OpenVPN i certificats</a></li>
<li class="chapter" data-level="5.8.12" data-path="vpn.html"><a href="vpn.html#mode-de-dispositiu"><i class="fa fa-check"></i><b>5.8.12</b> Mode de dispositiu</a></li>
<li class="chapter" data-level="5.8.13" data-path="vpn.html"><a href="vpn.html#configuració-1"><i class="fa fa-check"></i><b>5.8.13</b> Configuració</a></li>
<li class="chapter" data-level="5.8.14" data-path="vpn.html"><a href="vpn.html#configuracio-del-servidor"><i class="fa fa-check"></i><b>5.8.14</b> Configuracio del servidor</a></li>
<li class="chapter" data-level="5.8.15" data-path="vpn.html"><a href="vpn.html#servidors-dautentificacio"><i class="fa fa-check"></i><b>5.8.15</b> Servidors d’autentificacio</a></li>
<li class="chapter" data-level="5.8.16" data-path="vpn.html"><a href="vpn.html#exportar-els-arxius-de-configuracio-vpn-dels-clients"><i class="fa fa-check"></i><b>5.8.16</b> Exportar els arxius de configuracio VPN dels clients</a></li>
<li class="chapter" data-level="5.8.17" data-path="vpn.html"><a href="vpn.html#configuracio-vlan-en-ubuntu-host"><i class="fa fa-check"></i><b>5.8.17</b> Configuracio VLAN en ubuntu host</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="truenas.html"><a href="truenas.html"><i class="fa fa-check"></i><b>6</b> TrueNas</a>
<ul>
<li class="chapter" data-level="6.1" data-path="installar-truenass.html"><a href="installar-truenass.html"><i class="fa fa-check"></i><b>6.1</b> Instal·lar Truenass</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="installar-truenass.html"><a href="installar-truenass.html#afegirem-disc-de-pas-discs-reals"><i class="fa fa-check"></i><b>6.1.1</b> Afegirem disc de pas, discs reals</a></li>
<li class="chapter" data-level="6.1.2" data-path="installar-truenass.html"><a href="installar-truenass.html#afegim-el-disc-a-truenas"><i class="fa fa-check"></i><b>6.1.2</b> Afegim el disc a Truenas</a></li>
<li class="chapter" data-level="6.1.3" data-path="installar-truenass.html"><a href="installar-truenass.html#afegim-els-discs-a-proxmox"><i class="fa fa-check"></i><b>6.1.3</b> Afegim els discs a Proxmox</a></li>
<li class="chapter" data-level="6.1.4" data-path="installar-truenass.html"><a href="installar-truenass.html#volums"><i class="fa fa-check"></i><b>6.1.4</b> Volums</a></li>
<li class="chapter" data-level="6.1.5" data-path="installar-truenass.html"><a href="installar-truenass.html#zfs"><i class="fa fa-check"></i><b>6.1.5</b> ZFS</a></li>
<li class="chapter" data-level="6.1.6" data-path="installar-truenass.html"><a href="installar-truenass.html#configurar-el-nou-disk"><i class="fa fa-check"></i><b>6.1.6</b> Configurar el nou disk</a></li>
<li class="chapter" data-level="6.1.7" data-path="installar-truenass.html"><a href="installar-truenass.html#passthrough-disc-físic-a-màquina-virtual-forma-correcta"><i class="fa fa-check"></i><b>6.1.7</b> Passthrough disc físic a màquina virtual (forma correcta)</a></li>
<li class="chapter" data-level="6.1.8" data-path="installar-truenass.html"><a href="installar-truenass.html#crear-dataset"><i class="fa fa-check"></i><b>6.1.8</b> Crear dataset</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="politaca-de-volums.html"><a href="politaca-de-volums.html"><i class="fa fa-check"></i><b>6.2</b> Politaca de volums</a></li>
<li class="chapter" data-level="6.3" data-path="configuracio-del-disc-backup-total.html"><a href="configuracio-del-disc-backup-total.html"><i class="fa fa-check"></i><b>6.3</b> Configuracio del disc Backup Total</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="configuracio-del-disc-backup-total.html"><a href="configuracio-del-disc-backup-total.html#treballs-de-sincronitzacio"><i class="fa fa-check"></i><b>6.3.1</b> Treballs de sincronitzacio</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="nextcloud.html"><a href="nextcloud.html"><i class="fa fa-check"></i><b>7</b> Nextcloud</a>
<ul>
<li class="chapter" data-level="7.1" data-path="importar-imatge-.html"><a href="importar-imatge-.html"><i class="fa fa-check"></i><b>7.1</b> Importar imatge .vmdk</a></li>
<li class="chapter" data-level="7.2" data-path="volum-de-dades-nfs.html"><a href="volum-de-dades-nfs.html"><i class="fa fa-check"></i><b>7.2</b> volum de dades NFS</a></li>
<li class="chapter" data-level="7.3" data-path="gestió-dusuaris-openldap.html"><a href="gestió-dusuaris-openldap.html"><i class="fa fa-check"></i><b>7.3</b> Gestió d’usuaris openLDAP</a></li>
<li class="chapter" data-level="7.4" data-path="certificat-lets-encrypt.html"><a href="certificat-lets-encrypt.html"><i class="fa fa-check"></i><b>7.4</b> Certificat Let’s Encrypt</a></li>
<li class="chapter" data-level="7.5" data-path="configuracio-daplicacions-nextcloud.html"><a href="configuracio-daplicacions-nextcloud.html"><i class="fa fa-check"></i><b>7.5</b> Configuracio d’aplicacions Nextcloud</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="zoneminder.html"><a href="zoneminder.html"><i class="fa fa-check"></i><b>8</b> Zoneminder</a>
<ul>
<li class="chapter" data-level="8.1" data-path="ldap-apache.html"><a href="ldap-apache.html"><i class="fa fa-check"></i><b>8.1</b> LDAP Apache</a></li>
<li class="chapter" data-level="8.2" data-path="vlan.html"><a href="vlan.html"><i class="fa fa-check"></i><b>8.2</b> VLAN</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="vlan.html"><a href="vlan.html#configuracio-de-les-targetes-de-xarxa"><i class="fa fa-check"></i><b>8.2.1</b> Configuracio de les targetes de xarxa</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="configuració-de-les-càmeres.html"><a href="configuració-de-les-càmeres.html"><i class="fa fa-check"></i><b>8.3</b> Configuració de les càmeres</a></li>
<li class="chapter" data-level="8.4" data-path="espai-demmagatzematge.html"><a href="espai-demmagatzematge.html"><i class="fa fa-check"></i><b>8.4</b> Espai d’emmagatzematge</a></li>
<li class="chapter" data-level="8.5" data-path="proves-pendents.html"><a href="proves-pendents.html"><i class="fa fa-check"></i><b>8.5</b> Proves pendents</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="installació-de-wifi.html"><a href="installació-de-wifi.html"><i class="fa fa-check"></i><b>9</b> Instal·lació de wifi</a>
<ul>
<li class="chapter" data-level="9.0.1" data-path="installació-de-wifi.html"><a href="installació-de-wifi.html#potència-de-la-connexió-dinternet-per-donar-servei"><i class="fa fa-check"></i><b>9.0.1</b> Potència de la connexió d’internet per donar servei</a></li>
<li class="chapter" data-level="9.1" data-path="muntatge.html"><a href="muntatge.html"><i class="fa fa-check"></i><b>9.1</b> Muntatge</a></li>
<li class="chapter" data-level="9.2" data-path="com-fer-ho.html"><a href="com-fer-ho.html"><i class="fa fa-check"></i><b>9.2</b> Com fer-ho</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="com-fer-ho.html"><a href="com-fer-ho.html#procediment-1"><i class="fa fa-check"></i><b>9.2.1</b> Procediment</a></li>
<li class="chapter" data-level="9.2.2" data-path="com-fer-ho.html"><a href="com-fer-ho.html#assigna-les-vlan-al-controlador-unifi"><i class="fa fa-check"></i><b>9.2.2</b> Assigna les VLAN al controlador UniFi</a></li>
<li class="chapter" data-level="9.2.3" data-path="com-fer-ho.html"><a href="com-fer-ho.html#unifi-pfsense-on-instal.lar-el-controlador-de-les-antenes"><i class="fa fa-check"></i><b>9.2.3</b> unifi-pfsense, on instal.lar el controlador de les antenes</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Arts escèniques</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="installar-truenass" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> Instal·lar Truenass<a href="installar-truenass.html#installar-truenass" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Instal·lem TrueNass, creant un amfitrió de virtualització Proxmox amb un servidor NAS integrat. Instal·leu el NAS com qualsevol altra màquina virtual amb el seu sistema operatiu residint en un disc virtual en <em>vmZFS</em>. Les unitats d’emmagatzematge reals residiran a l’emmagatzematge físic <em>zfspool1</em> assignat mitjançant una tècnica coneguda com a pas de maquinari.</p>
<p>Creem una nova màquina virtual com sempre amb la següent configuració.</p>
<div class="figure">
<img src="imatges/proxmox/truenas_config.png" style="width:50.0%" alt="" />
<p class="caption">Configuracio de la VM TrueNas</p>
</div>
<div class="rmdinfo centre">
<p>El disc sata1 que es veu en la configuració, l’afegirem ara seguint els següents passos.</p>
</div>
<p>Arranquem i comença la instal·lacio.</p>
<div class="figure">
<img src="imatges/proxmox/truenas_in1.png" style="width:50.0%" alt="" />
<p class="caption">Instala.lació de Truenas</p>
</div>
<p>De moment soles tenim el disc dur per instal·lar el sistema base, 32 Gib que està en l’espai vmZFS del host. L’altre, el d’espai, l’afegirem després.</p>
<div class="figure">
<img src="imatges/proxmox/truenas_in2.png" style="width:50.0%" alt="" />
<p class="caption">Elegir disc per la instal·lació</p>
</div>
<p>Seguim els passos fins al final, com qualsevol SO, i reiniciem.</p>
<div class="figure">
<img src="imatges/proxmox/truenas_arr0.png" style="width:50.0%" alt="" />
<p class="caption">Pimera arrancada</p>
</div>
<p>Des d’aci podríem configurar la xarxa i canviar al password del root per poder entrar des del navegador.</p>
<p>La xarxa de moment no la toquem fins que no estiga tot configurat en pfSense, i el passem a les VLAN que li adjudiquem.</p>
<div class="figure">
<img src="imatges/proxmox/trunas_ar1.png" style="width:50.0%" alt="" />
<p class="caption">Truenas GUI</p>
</div>
<div class="rmdinfo centre">
<p>L’usuari que pot entrar és root amb el password que li hem posat en el pas anterior.</p>
</div>
<div class="figure">
<img src="imatges/proxmox/truena_ar2.png" style="width:80.0%" alt="" />
<p class="caption">Truenas GUI web</p>
</div>
<div id="afegirem-disc-de-pas-discs-reals" class="section level3 hasAnchor" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> Afegirem disc de pas, discs reals<a href="installar-truenass.html#afegirem-disc-de-pas-discs-reals" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>D’aquesta forma tenim separades en dos discs, la VM i les dades. Aquest mètode permet una còpia de seguretat del sistema molt petita, perquè només feu una còpia de seguretat del sistema operatiu VM Truenas i NO de les dades. També proporciona un rendiment de disc moderadament millor per als cicles de lectura/escriptura</p>
<p>El més gran avantatge és que les dades NO s’emmagatzemen en un fitxer de disc virtual. Si es destrueix la VM, les dades estan segures en un disc real, que es pot muntar amb qualsevol altre SO.</p>
</div>
<div id="afegim-el-disc-a-truenas" class="section level3 hasAnchor" number="6.1.2">
<h3><span class="header-section-number">6.1.2</span> Afegim el disc a Truenas<a href="installar-truenass.html#afegim-el-disc-a-truenas" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Per buscar els discs durs en Trueas</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb42-1"><a href="installar-truenass.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /proc/partitions</span></code></pre></div>
<p>Podem crea un LVM o un ZFS, per aquest espai</p>
<p>Afegim 3 discs durs, tenim dues opcions</p>
<ul>
<li><p>Fer una RAID0 en dos discs i l’altre disc per fer les còpies de seguretat de les parts que ens interesse guardar.</p>
<p>En el primer volum, de dos discs, és on guardarem les dades del nextcloud, els fitxers de la part administrativa, les captures de video i tots els espais de disc compartits amb els serveis que oferirem ara o en un futur. En el segon volum, el tercer disc dur, farem una rèplica de les dades de Nextcloud i serveis, la part administrativa i la carpeta de <em>videos editats</em>.</p></li>
</ul>
<p>::: {.rmdnote data-latex=“{Nota}”}
Per la forma de treballar de l’empresa, no ens interessa còpies de seguretat de totes les captures de video, ja que es vol oferir com un servei per a les companyies externes que actuen, i després esborrar-les. Soles les còpies de les obres pròpies es voldrien guardar. Si fem un RAID 1 carreguem el sistema TrueNas en càlculs, fent el disc de paritat, quan la major part de les dades no ens interessa. És molt més rapid, canviar un disc que es trenca i restaurar la còpia de seguretat, que restaurar la paritat d’un sistema RAID 1, on mes de la meitat de les dades que es restauren ens són indiferent.
:::</p>
<p>En cas de catàstrofe</p>
<ol style="list-style-type: decimal">
<li>En cas de catàstrofe d’un dels discs del volum 1, es canvia i es restaura les còpies de seguretat.</li>
<li>En cas de desastre en disc de còpies de seguretat, es canvia i es regeneren les imatges de les VM i es torna a fer còpia de seguretat de les dades.</li>
<li>En cas de catàstrofe en el ssd on està el proxmox, el canviem, instal·lem altra vegada Proxmos, connectem el volum de còpies de seguretat i restaurem la configuració de proxmox i les VM.</li>
</ol>
<div class="rmdtip">
<p>Un altre avantatge d’aquest mètode, és que amb RAID0, la velocitat del disc format d’aquesta forma és més ràpit. Ja que reparteix la lectura i escriptura entre els dos discs. Si li donem molta resolució a les càmeres, igual si vindria bé aquest plus de velocitat enfront del de seguretat, si al mateix temps estan utilitzant el Nextcloud per llegir fitxers.</p>
</div>
<ul>
<li><p>Fer un RAID 1 en els tres discs. Si falla un, el canviem i es regenera la paritat.</p>
<p>3 SATA RAID 1 en els tres discs. Fer un volum en els tres discs i guardar alli el backup, les dades i els videos, cada u en el seu Zvol.</p></li>
</ul>
<p>En cas de catàstrofe</p>
<ol style="list-style-type: decimal">
<li>En cas de catàstrofe del ssd, igual que en cas anterior</li>
<li>En cas de catàstrofe d’un dels 3 discs, es canvia i es regenera el RAID automàticament, és procés pot ser més lent que el de tornar a copiar les dades de des del backup. Ja que tindríem moltes dades que realment no volem que es tornarien a regenerar,</li>
</ol>
</div>
<div id="afegim-els-discs-a-proxmox" class="section level3 hasAnchor" number="6.1.3">
<h3><span class="header-section-number">6.1.3</span> Afegim els discs a Proxmox<a href="installar-truenass.html#afegim-els-discs-a-proxmox" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Ho he fet de dues formes diferents. La segona em pareix la més correcta, pero deixe la documentació de la primera, perquè part dels següents passos per compartir espai en Nextcloud ho vaig fer en el volum creat d’aquesta forma. No està de més tindre la documentació de com es va fer, per si en algun cas específic, convé més fer-ho d’aquesta manera.</p>
<p>En la realitat, li posaríem els discs en les valdes del servidor.
En l’edició de proves, hem creat tres discs durs virtuals en format qcow2 en la partició HD del portàtil, no SSD.</p>
<div class="figure">
<img src="imatges/proxmox/Afegir_disc_pro1.png" style="width:50.0%" alt="" />
<p class="caption">seleccionar disc durs</p>
</div>
<div class="figure">
<img src="imatges/proxmox/afegir_disc_pro2.png" style="width:50.0%" alt="" />
<p class="caption">afegir discs</p>
</div>
<p>Hem elegit tipus de bus VirtiO que és el que en principi dona més rendiment i ens deixa fer més coses, si dona problemes es pot elegir SATA que és el real.</p>
</div>
<div id="volums" class="section level3 hasAnchor" number="6.1.4">
<h3><span class="header-section-number">6.1.4</span> Volums<a href="installar-truenass.html#volums" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Ara hem d’elegir el tipus de volum que volem crear, LVM o ZFS.</p>
<p>En principi LVM és més pràctic, i els requisits de hardware, en concret de RAM és minim. Arranquem qualsevol linux, muntem el volum, i accedim a les dades. En ZFS el mateix, pero no és tan usual, i els requisits de RAM per aquest volum és més alt. Es recomana minim 4GiB, pero l’òptim son 8GiB, i 1GiB per cada Tera de mes. En el nostre cas, si es compra el servidor en 64GiB de RAM, no seria problema, la resta de VM no tenen gran demanda de RAM.</p>
<div class="rmdcuidao">
<p>ZFS depén molt de la memòria, de manera que necessiteu almenys 8 GB per començar. A la pràctica, utilitzeu tot el que pugueu obtenir pel vostre maquinari/pressupost. Si no tenim tanta RAM, es pot gastar un disc SSD, sol ser més barat, es pot comprar en altre SSD de menor capacitat per fer aço, no recomane fer-ho en una partició de l’arrel de Proxmox, aço el desgasta molt i tenim mes probabilitat que falle mes ràpidament. Es posa un secundari, i quan falle es canvia, pero si tenim RAM millor, i es el cas.
Crea un grup nou amb memòria cau (L2ARC)
És possible emprar una partició d’unitat de memòria cau dedicada per augmentar el rendiment (fa ús SSD).</p>
</div>
<p>El crearíem en cas de falta de recursos.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="installar-truenass.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">zpool</span> create <span class="at">-f</span> <span class="at">-o</span> ashift=12 <span class="op">&lt;</span>pool<span class="op">&gt;</span> <span class="op">&lt;</span>device<span class="op">&gt;</span> cache <span class="op">&lt;</span>cache_device<span class="op">&gt;</span></span></code></pre></div>
</div>
<div id="zfs" class="section level3 hasAnchor" number="6.1.5">
<h3><span class="header-section-number">6.1.5</span> ZFS<a href="installar-truenass.html#zfs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Elegim ZFS pel format de tots els nostres discs.</p>
<p>ZFS és un sistema de fitxers combinat i un gestor de volums lògics dissenyat per Sun Microsystems.</p>
<p>L’emmagatzematge ZFS és una combinació de sistema de fitxers i LVM, que proporciona emmagatzematge d’alta capacitat amb funcions importants, com ara protecció de dades, compressió de dades, autocuració i instantànies. ZFS té un RAID definit per programari integrat, que fa que l’ús de RAID basat en maquinari siga innecessari.</p>
<div class="rmdnote">
<p>Una matriu de discs amb ZFS RAID es pot migrar a un node completament diferent i després importar-la completament sense reconstruir tota la matriu. Només podem emmagatzemar imatges de disc virtual en format .raw a l’emmagatzematge ZFS.</p>
</div>
<p>Mitjançant l’ús de ZFS, és possible aconseguir les màximes funcions empresarials amb maquinari de baix pressupost, però també sistemes d’alt rendiment aprofitant la memòria cau SSD o fins i tot configuracions només SSD. ZFS pot substituir les targetes RAID de maquinari de costos intensos per una càrrega moderada de CPU i memòria combinada amb una gestió fàcil.</p>
<p>Avantatges</p>
<ul>
<li><p>Fiable</p></li>
<li><p>Protecció contra la corrupció de dades</p></li>
<li><p>Compressió de dades en l’àmbit de sistema de fitxers</p></li>
<li><p>Imatges instantànies</p></li>
<li><p>Clon de còpia sobre escriptura</p></li>
<li><p>Diversos nivells de raid: RAID0, RAID1, RAID10, RAIDZ-1, RAIDZ-2 i RAIDZ-3</p></li>
<li><p>Pot utilitzar SSD per a la memòria cau</p></li>
<li><p>Autocuració</p></li>
<li><p>Comprovació contínua d’integritat</p></li>
<li><p>Dissenyat per a altes capacitats d’emmagatzematge</p></li>
<li><p>Replicació asíncrona a la xarxa</p></li>
<li><p>Encriptació</p></li>
</ul>
<p>Després d’afegir els discs, en proxmox apareixen directament.
Tenim els nous discs vdc. vdd i vde</p>
<div class="figure">
<img src="imatges/proxmox/prox_disc.png" style="width:80.0%" alt="" />
<p class="caption">Nous discs</p>
</div>
<p>Per fer RAID0 ho hem de fer des de consola, aquesta opció no la proporciona el GUI, i a més no la recomana, si es perd un disc, es perden les dades.</p>
<div class="figure">
<img src="imatges/proxmox/prox_disc_no0.png" style="width:80.0%" alt="" />
<p class="caption">No es pot Crear RAID0 des del GUI</p>
</div>
<p>Per fer-ho mirem la <a href="https://pve.proxmox.com/wiki/ZFS_on_Linux">documentació</a> oficial.</p>
<p>RAID0
També s’anomena “striping”. La capacitat d’aquest volum és la suma de les capacitats de tots els discs. Però RAID0 no afegeix cap redundància, per la qual cosa la fallada d’una sola unitat fa que el volum no es puga utilitzar.</p>
<p>Quan s’escriu una matriu de paritat com ara RAID (1, 5, 6 o 10), s’ha de sincronitzar la memòria cau de dades sense interrupcions o es degradarà. Si es degrada, es reconstruirà! Si es reconstrueix, introdueix un cicle de treball estés i una acumulació de calor. Aquesta acumulació de calor degrada els components de manera irreversible que condueix a una eventual fallada.</p>
<p>Una matriu de striping com ara RAID-0 mai no se sincronitza ni es degrada. Això redueix el cicle de treball i l’acumulació de calor augmentant així la vida útil dels components.</p>
<p>Construïm el nostre sistema utilitzant només matrius de striping sense paritat i després fem servir RSync o replica per a replicar les dades en diverses màquines o volums del NAS. Això ofereix el rendiment de RAID-0 mantenint la redundància de dades.</p>
<p>Sembla que es compleixen tots els requisits, excepte les sol·licituds de restauració de l’usuari final i minimitzar la corrupció de dades. Per aço tindrem TruNAS amb ZFS.</p>
<p>Per crear l’agrupació ZFS</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb44-1"><a href="installar-truenass.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="ex">zpool</span> create <span class="op">&lt;</span>nom_agrupació<span class="op">&gt;</span> <span class="op">&lt;</span>tipus_raid<span class="op">&gt;</span> <span class="op">&lt;</span>nom_dev1<span class="op">&gt;</span> <span class="op">&lt;</span>nom_dev2<span class="op">&gt;</span></span></code></pre></div>
<p>Tipus de RAID ZFS</p>
<table>
<thead>
<tr class="header">
<th>Tipus RAID</th>
<th>Parametre</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RAID0</td>
<td>no string (res)</td>
</tr>
<tr class="even">
<td>RAID 1</td>
<td>mirror</td>
</tr>
<tr class="odd">
<td>RAIDZ-1</td>
<td>raidz1</td>
</tr>
<tr class="even">
<td>RAIDZ-2</td>
<td>raidz2</td>
</tr>
</tbody>
</table>
<p>En el nostre cas li direm zfspool1 i del tipus RAID0 que és no string, és a dir, no posar res.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="installar-truenass.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="ex">zpool</span> create zfspool1 /dev/vdc /dev/vdd</span></code></pre></div>
<div class="rmdinfo centre">
<p>Son <em>/dev/vdx</em> per què son discs virtuals, en el server seran <em>/dev/sdx</em></p>
</div>
<p>Per verificar que el grup s’ha creat</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb46-1"><a href="installar-truenass.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="ex">root@proxmox:~#</span> zpool list</span>
<span id="cb46-2"><a href="installar-truenass.html#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="ex">NAME</span>       SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT</span>
<span id="cb46-3"><a href="installar-truenass.html#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="ex">rpool</span>       39G  1.24G  37.8G        <span class="at">-</span>         <span class="at">-</span>     1%     3%  1.00x    ONLINE  <span class="at">-</span></span>
<span id="cb46-4"><a href="installar-truenass.html#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="ex">vmZFS</span>     99.5G  16.6G  82.9G        <span class="at">-</span>         <span class="at">-</span>     3%    16%  1.00x    ONLINE  <span class="at">-</span></span>
<span id="cb46-5"><a href="installar-truenass.html#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="ex">zfspool1</span>    99G   105K  99.0G        <span class="at">-</span>         <span class="at">-</span>     0%     0%  1.00x    ONLINE  <span class="at">-</span></span></code></pre></div>
<p>S’ha creat zfspool1 en l’espai sencer dels dos discs durs</p>
<p>Podem utilitzar l’agrupació directament o podem crear un conjunt de dades (dataset) dins de l’agrupació i connectar-lo per separat a Proxmox com a emmagatzematge individual. L’avantatge d’això és aïllar els diferents tipus de dades emmagatzemades en cada conjunt de dades. Aquesta part la farem en Truenas, crearem conjunts de dades per a cada servei.</p>
<p>Cada conjunt de dades ZFS es pot configurar individualment amb el seu propi conjunt d’opcions de configuració encriptació, compressió…</p>
<div class="rmdinfo">
<p>Podem activar la compressió per al conjunt de dades de les VM mentre mantenim la compressió desactivada per al conjunt de dades d’emmagatzematge de còpia de seguretat dels fitxers de còpia de seguretat de VM i video. Ja estan comprimits, estalviant així recursos valuosos del servidor.</p>
</div>
<p>Per crear els conjunts de dades, que es diu pool en ZFS</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb47-1"><a href="installar-truenass.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="ex">zfs</span> crea <span class="op">&lt;</span>zpool_name<span class="op">&gt;</span>/<span class="op">&lt;</span>zfs_dataset_name<span class="op">&gt;</span></span></code></pre></div>
<p>El <em>zpool_name</em> és el que hem creat <em>zfspool1</em> i el <em>dataset</em> el que volem crear, <em>next</em> per exemple, per a les dades de Nextcloud.</p>
<p>Els conjunts de dades s’han de muntar en un directori abans que es puguen utilitzar. De manera predeterminada, un nou conjunt de dades o conjunt de dades zfs es munta al directori arrel.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="installar-truenass.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="ex">zfs</span> set mountpoint=/mnt/zfs-vm zfspool1/next</span></code></pre></div>
<p>En el nostre cas li direm zfspool1 i del tipus RAID0 que és no string</p>
<p>Per habilitar la compressió per al conjunt de dades</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb49-1"><a href="installar-truenass.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="ex">zfs</span> set compression=on zfspool1/next</span></code></pre></div>
<p>En combinar l’agrupació ZFS amb una compartició NFS, podem crear un emmagatzematge compartit amb funcions ZFS completes. Creant d’aquesta forma un emmagatzematge compartit flexible. Podríem muntar cada volum en la màquina virtual que el vol fer servir, sense falta del Truenas, pero haguérem de donar-li RAM suficient a cada màquina per a gestionar ZFS i les tasques de còpia de seguretat serien més laborioses. Millor centralitzar-ho tot en una VM dedicada a aquestes labors com Truenas.</p>
<div class="rmdtip">
<p>Si tinguerem soles el Truenas, tots els passos de la creació de la pool ens els podríem haver estalviat, es pot fer mitjançant la seua GUI.</p>
</div>
<p>Ara l’afegim, al nostre servidor proxmox per passar-lo després a la VM Truenas.</p>
<p>En centre de dades -&gt; emmagatzemament -&gt; ZFS -&gt; afegir</p>
<p>L’ID és el nom que li volem donar que siga únic en el servidor. Elegim el zfspool1, el mateix que en el que l’hem creat.</p>
<div class="figure">
<img src="imatges/proxmox/afegir_pool.png" style="width:80.0%" alt="" />
<p class="caption">Afegir disc ZFS</p>
</div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:sheets-option-drag1"></span>
<img src="imatges/proxmox/afegirpool.gif" alt="(Afegir pool a proxmox)"  />
<p class="caption">
Imatge 6.1: (Afegir pool a proxmox)
</p>
</div>
<p>Ara l’afegirem a Tuenas.</p>
<p>En la màquina virtual afegim el disc ZFS que acabem de crear. L’afegim d’aquesta forma virtIO block perquè el disc siga una unitat física real, no un disc dur virtual. Les dades estan en un disc real i no en una imatge de màquina virtual, i es pot accedir a elles encara que la VM ja no estiga.</p>
<div class="rmdcuidao">
<p>No em deixa posar més de 93GiB, diu que el disc supera l’espai, coses de ZFS que es fa una partició reservada.</p>
</div>
<div class="figure">
<img src="imatges/proxmox/disc_freenas.png" style="width:80.0%" alt="" />
<p class="caption">Afegir el disc a freeNas en mode pass</p>
</div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:sheets-option-drag2"></span>
<img src="imatges/proxmox/disc_freenas.gif" alt="(Disc afegit a Truenas)"  />
<p class="caption">
Imatge 6.2: (Disc afegit a Truenas)
</p>
</div>
</div>
<div id="configurar-el-nou-disk" class="section level3 hasAnchor" number="6.1.6">
<h3><span class="header-section-number">6.1.6</span> Configurar el nou disk<a href="installar-truenass.html#configurar-el-nou-disk" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Dins de Truenas, anem a storage -&gt; diks per configurar-lo</p>
<div class="figure">
<img src="imatges/proxmox/truenas_nou_disc.png" style="width:80.0%" alt="" />
<p class="caption">Truenas configurar el nou disc</p>
</div>
<p>Li podríem canviar les opcions d’energia del disc, encriptar …</p>
<div class="figure">
<img src="imatges/proxmox/truenas_param_hd.png" style="width:80.0%" alt="" />
<p class="caption">Configurem el HD</p>
</div>
<p>I ho salvem</p>
<div class="rmdcuidao">
<p>En principi és indiferent qui cee els volums ZFS, en el proposat abans els fa Proxmox i després el muntem per compartir-lo en Truenas, pero no sé si és la forma més correcta de fer-ho. Ho vaig fer al principi i és la solució que vaig trobar, per a la resta de configuracions d’espais de dades i zvol compartits no afecta. Per al tercer disc SATA el que farà de Còpia de seguretat Total, repetirem el procés, pero tot amb la GUI de Truenas. En la pràctica seria soles amb un disc SATA, pero per fer la demostració, ho farem en dos discs com abans, una vegada fet el volum, la resta és com si fora soles una unitat física.</p>
</div>
<div class="rmdinfo centre">
<p>A partir d’aci, crearíem la primera pool igual que l’apartat posterior, pero soles amb el disc ada0.</p>
</div>
</div>
<div id="passthrough-disc-físic-a-màquina-virtual-forma-correcta" class="section level3 hasAnchor" number="6.1.7">
<h3><span class="header-section-number">6.1.7</span> Passthrough disc físic a màquina virtual (forma correcta)<a href="installar-truenass.html#passthrough-disc-físic-a-màquina-virtual-forma-correcta" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><a href="https://pve.proxmox.com/wiki/Passthrough_Physical_Disk_to_Virtual_Machine_(VM)">Passthrough disc físic a màquina virtual (VM)</a></p>
<p>Per fer-ho d’aquesta segona forma, hem afegit dos discs més a proxmox per KVM
/dev/vdf /dev/vdg</p>
<div class="figure">
<img src="imatges/proxmox/Afegir_passtrhough.png" alt="" />
<p class="caption">Afegir dos discs nouns a Proxmox</p>
</div>
<div class="rmdinfo">
<p>La idea era que aci tindrien soles el tercer SATA, pero afegim dos per fer el RAID per Truenas que no hem fet abans.</p>
</div>
<p>Primer hem de veure les característiques dels discs a afegir amb lshw</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb50-1"><a href="installar-truenass.html#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="ex">root@proxmox:~#</span> lshw <span class="at">-class</span> disk <span class="at">-class</span> storage </span>
<span id="cb50-2"><a href="installar-truenass.html#cb50-2" aria-hidden="true" tabindex="-1"></a> <span class="ex">*-scsi</span>                    </span>
<span id="cb50-3"><a href="installar-truenass.html#cb50-3" aria-hidden="true" tabindex="-1"></a>       <span class="ex">description:</span> SCSI storage controller</span>
<span id="cb50-4"><a href="installar-truenass.html#cb50-4" aria-hidden="true" tabindex="-1"></a>       <span class="ex">product:</span> Virtio block device</span>
<span id="cb50-5"><a href="installar-truenass.html#cb50-5" aria-hidden="true" tabindex="-1"></a>       <span class="ex">vendor:</span> Red Hat, Inc.</span>
<span id="cb50-6"><a href="installar-truenass.html#cb50-6" aria-hidden="true" tabindex="-1"></a>       <span class="ex">physical</span> id: 0</span>
<span id="cb50-7"><a href="installar-truenass.html#cb50-7" aria-hidden="true" tabindex="-1"></a>       <span class="ex">bus</span> info: pci@0000:04:00.0</span>
<span id="cb50-8"><a href="installar-truenass.html#cb50-8" aria-hidden="true" tabindex="-1"></a>       <span class="ex">version:</span> 01</span>
<span id="cb50-9"><a href="installar-truenass.html#cb50-9" aria-hidden="true" tabindex="-1"></a>       <span class="ex">width:</span> 64 bits</span>
<span id="cb50-10"><a href="installar-truenass.html#cb50-10" aria-hidden="true" tabindex="-1"></a>       <span class="ex">clock:</span> 33MHz</span>
<span id="cb50-11"><a href="installar-truenass.html#cb50-11" aria-hidden="true" tabindex="-1"></a>       <span class="ex">capabilities:</span> scsi msix pm pciexpress bus_master cap_list</span>
<span id="cb50-12"><a href="installar-truenass.html#cb50-12" aria-hidden="true" tabindex="-1"></a>       <span class="ex">configuration:</span> driver=virtio-pci latency=0</span>
<span id="cb50-13"><a href="installar-truenass.html#cb50-13" aria-hidden="true" tabindex="-1"></a>       <span class="ex">resources:</span> irq:22 memory:f9a00000-f9a00fff memory:fe400000-fe403fff</span>
<span id="cb50-14"><a href="installar-truenass.html#cb50-14" aria-hidden="true" tabindex="-1"></a>     <span class="ex">*-virtio2</span></span>
<span id="cb50-15"><a href="installar-truenass.html#cb50-15" aria-hidden="true" tabindex="-1"></a>          <span class="ex">description:</span> Virtual I/O device</span>
<span id="cb50-16"><a href="installar-truenass.html#cb50-16" aria-hidden="true" tabindex="-1"></a>          <span class="ex">physical</span> id: 0</span>
<span id="cb50-17"><a href="installar-truenass.html#cb50-17" aria-hidden="true" tabindex="-1"></a>          <span class="ex">bus</span> info: virtio@2</span>
<span id="cb50-18"><a href="installar-truenass.html#cb50-18" aria-hidden="true" tabindex="-1"></a>          <span class="ex">logical</span> name: /dev/vda</span>
<span id="cb50-19"><a href="installar-truenass.html#cb50-19" aria-hidden="true" tabindex="-1"></a>          <span class="ex">size:</span> 40GiB <span class="er">(</span><span class="ex">42GB</span><span class="kw">)</span></span>
<span id="cb50-20"><a href="installar-truenass.html#cb50-20" aria-hidden="true" tabindex="-1"></a>          <span class="ex">capabilities:</span> gpt-1.00 partitioned partitioned:gpt</span>
<span id="cb50-21"><a href="installar-truenass.html#cb50-21" aria-hidden="true" tabindex="-1"></a>          <span class="ex">configuration:</span> driver=virtio_blk</span>
<span id="cb50-22"><a href="installar-truenass.html#cb50-22" aria-hidden="true" tabindex="-1"></a>          <span class="va">guid</span><span class="op">=</span>f2e35e7d-3cde-4753-be5c-f7e181a4f0fe <span class="va">logicalsectorsize</span><span class="op">=</span>512</span>
<span id="cb50-23"><a href="installar-truenass.html#cb50-23" aria-hidden="true" tabindex="-1"></a>          <span class="va">sectorsize</span><span class="op">=</span>512</span>
<span id="cb50-24"><a href="installar-truenass.html#cb50-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-25"><a href="installar-truenass.html#cb50-25" aria-hidden="true" tabindex="-1"></a><span class="ex">....</span></span>
<span id="cb50-26"><a href="installar-truenass.html#cb50-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-27"><a href="installar-truenass.html#cb50-27" aria-hidden="true" tabindex="-1"></a>  <span class="ex">*-scsi</span></span>
<span id="cb50-28"><a href="installar-truenass.html#cb50-28" aria-hidden="true" tabindex="-1"></a>       <span class="ex">description:</span> SCSI storage controller</span>
<span id="cb50-29"><a href="installar-truenass.html#cb50-29" aria-hidden="true" tabindex="-1"></a>       <span class="ex">product:</span> Virtio block device</span>
<span id="cb50-30"><a href="installar-truenass.html#cb50-30" aria-hidden="true" tabindex="-1"></a>       <span class="ex">vendor:</span> Red Hat, Inc.</span>
<span id="cb50-31"><a href="installar-truenass.html#cb50-31" aria-hidden="true" tabindex="-1"></a>       <span class="ex">physical</span> id: 0</span>
<span id="cb50-32"><a href="installar-truenass.html#cb50-32" aria-hidden="true" tabindex="-1"></a>       <span class="ex">bus</span> info: pci@0000:0f:00.0</span>
<span id="cb50-33"><a href="installar-truenass.html#cb50-33" aria-hidden="true" tabindex="-1"></a>       <span class="ex">version:</span> 01</span>
<span id="cb50-34"><a href="installar-truenass.html#cb50-34" aria-hidden="true" tabindex="-1"></a>       <span class="ex">width:</span> 64 bits</span>
<span id="cb50-35"><a href="installar-truenass.html#cb50-35" aria-hidden="true" tabindex="-1"></a>       <span class="ex">clock:</span> 33MHz</span>
<span id="cb50-36"><a href="installar-truenass.html#cb50-36" aria-hidden="true" tabindex="-1"></a>       <span class="ex">capabilities:</span> scsi msix pm pciexpress bus_master cap_list</span>
<span id="cb50-37"><a href="installar-truenass.html#cb50-37" aria-hidden="true" tabindex="-1"></a>       <span class="ex">configuration:</span> driver=virtio-pci latency=0</span>
<span id="cb50-38"><a href="installar-truenass.html#cb50-38" aria-hidden="true" tabindex="-1"></a>       <span class="ex">resources:</span> irq:23 memory:f8600000-f8600fff memory:fd000000-fd003fff</span>
<span id="cb50-39"><a href="installar-truenass.html#cb50-39" aria-hidden="true" tabindex="-1"></a>     <span class="ex">*-virtio11</span></span>
<span id="cb50-40"><a href="installar-truenass.html#cb50-40" aria-hidden="true" tabindex="-1"></a>          <span class="ex">description:</span> Virtual I/O device</span>
<span id="cb50-41"><a href="installar-truenass.html#cb50-41" aria-hidden="true" tabindex="-1"></a>          <span class="ex">physical</span> id: 0</span>
<span id="cb50-42"><a href="installar-truenass.html#cb50-42" aria-hidden="true" tabindex="-1"></a>          <span class="ex">bus</span> info: virtio@11</span>
<span id="cb50-43"><a href="installar-truenass.html#cb50-43" aria-hidden="true" tabindex="-1"></a>          <span class="ex">logical</span> name: /dev/vdf</span>
<span id="cb50-44"><a href="installar-truenass.html#cb50-44" aria-hidden="true" tabindex="-1"></a>          <span class="ex">size:</span> 50GiB <span class="er">(</span><span class="ex">53GB</span><span class="kw">)</span></span>
<span id="cb50-45"><a href="installar-truenass.html#cb50-45" aria-hidden="true" tabindex="-1"></a>          <span class="ex">configuration:</span> driver=virtio_blk logicalsectorsize=512 sectorsize=512</span>
<span id="cb50-46"><a href="installar-truenass.html#cb50-46" aria-hidden="true" tabindex="-1"></a>  <span class="ex">*-scsi</span></span>
<span id="cb50-47"><a href="installar-truenass.html#cb50-47" aria-hidden="true" tabindex="-1"></a>       <span class="ex">description:</span> SCSI storage controller</span>
<span id="cb50-48"><a href="installar-truenass.html#cb50-48" aria-hidden="true" tabindex="-1"></a>       <span class="ex">product:</span> Virtio block device</span>
<span id="cb50-49"><a href="installar-truenass.html#cb50-49" aria-hidden="true" tabindex="-1"></a>       <span class="ex">vendor:</span> Red Hat, Inc.</span>
<span id="cb50-50"><a href="installar-truenass.html#cb50-50" aria-hidden="true" tabindex="-1"></a>       <span class="ex">physical</span> id: 0</span>
<span id="cb50-51"><a href="installar-truenass.html#cb50-51" aria-hidden="true" tabindex="-1"></a>       <span class="ex">bus</span> info: pci@0000:10:00.0</span>
<span id="cb50-52"><a href="installar-truenass.html#cb50-52" aria-hidden="true" tabindex="-1"></a>       <span class="ex">version:</span> 01</span>
<span id="cb50-53"><a href="installar-truenass.html#cb50-53" aria-hidden="true" tabindex="-1"></a>       <span class="ex">width:</span> 64 bits</span>
<span id="cb50-54"><a href="installar-truenass.html#cb50-54" aria-hidden="true" tabindex="-1"></a>       <span class="ex">clock:</span> 33MHz</span>
<span id="cb50-55"><a href="installar-truenass.html#cb50-55" aria-hidden="true" tabindex="-1"></a>       <span class="ex">capabilities:</span> scsi msix pm pciexpress bus_master cap_list</span>
<span id="cb50-56"><a href="installar-truenass.html#cb50-56" aria-hidden="true" tabindex="-1"></a>       <span class="ex">configuration:</span> driver=virtio-pci latency=0</span>
<span id="cb50-57"><a href="installar-truenass.html#cb50-57" aria-hidden="true" tabindex="-1"></a>       <span class="ex">resources:</span> irq:23 memory:f8400000-f8400fff memory:fce00000-fce03fff</span>
<span id="cb50-58"><a href="installar-truenass.html#cb50-58" aria-hidden="true" tabindex="-1"></a>     <span class="ex">*-virtio12</span></span>
<span id="cb50-59"><a href="installar-truenass.html#cb50-59" aria-hidden="true" tabindex="-1"></a>          <span class="ex">description:</span> Virtual I/O device</span>
<span id="cb50-60"><a href="installar-truenass.html#cb50-60" aria-hidden="true" tabindex="-1"></a>          <span class="ex">physical</span> id: 0</span>
<span id="cb50-61"><a href="installar-truenass.html#cb50-61" aria-hidden="true" tabindex="-1"></a>          <span class="ex">bus</span> info: virtio@12</span>
<span id="cb50-62"><a href="installar-truenass.html#cb50-62" aria-hidden="true" tabindex="-1"></a>          <span class="ex">logical</span> name: /dev/vdg</span>
<span id="cb50-63"><a href="installar-truenass.html#cb50-63" aria-hidden="true" tabindex="-1"></a>          <span class="ex">size:</span> 50GiB <span class="er">(</span><span class="ex">53GB</span><span class="kw">)</span></span>
<span id="cb50-64"><a href="installar-truenass.html#cb50-64" aria-hidden="true" tabindex="-1"></a>          <span class="ex">configuration:</span> driver=virtio_blk logicalsectorsize=512 sectorsize=512</span></code></pre></div>
<p>Ens interessen els dos últims virtio11 virtio12 de 53 GB pero al ser un disc virtual en realitat no apareix el model del producte ni el guid, els afegirem per dev/vdf i g com a SATA2 i 3, millor seria afegir-los per by-id.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb51-1"><a href="installar-truenass.html#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="ex">root@proxmox:~#</span> qm set  102  <span class="at">-sata2</span> /dev/vdg</span>
<span id="cb51-2"><a href="installar-truenass.html#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="ex">update</span> VM 102: <span class="at">-sata2</span> /dev/vdg</span>
<span id="cb51-3"><a href="installar-truenass.html#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="ex">root@proxmox:~#</span> qm set  102  <span class="at">-sata3</span> /dev/vdf</span>
<span id="cb51-4"><a href="installar-truenass.html#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="ex">update</span> VM 102: <span class="at">-sata3</span> /dev/vdf</span></code></pre></div>
<p>Ara ja apareixen en la VM de truenas com SATA2 i 3. Estan connectats a Truenas, sense estar manipulats ni muntats en Proxmox. L’hem d’afegir de tipus SATA perquè es crega que és un disc real, si el posem com scsi el detecta com a qcow, i no el podem enganyar.</p>
<div class="figure">
<img src="imatges/proxmox/trunas_disc_fg.png" style="width:50.0%" alt="" />
<p class="caption">Afegir discs directament Truenas</p>
</div>
<p>En entrar en la GUI, en discs, ens apareixen els nous dos discs ada1 ada2, el ada0 és el zfspool1 del primer pas.</p>
<div class="figure">
<img src="imatges/proxmox/true_da0.png" alt="" />
<p class="caption">Discs des de Truenas</p>
</div>
<p>Ara crearem el pool amb aquests dos discs.
Guia <a href="https://www.truenas.com/docs/core/gettingstarted/storingdata/">Storage Configuration</a></p>
<div class="rmdnote">
<p>La pool que es veu datatruenas és la que vam crear en el volum zfspool1 per les dades de Nextcloud i còpia de seguretat que es detalla com crear-les i compartir-les en els apartats corresponents a aquestes VM.</p>
</div>
<p>Una vegada ja tenim els nous discs afegits, anem a piscines (pools) per crear la nova unitat amb afegir.</p>
<div class="figure">
<img src="imatges/proxmox/disc_pastrougt1.png" style="width:80.0%" alt="" />
<p class="caption">Anem a pool per crear una nova</p>
</div>
<p>Seguim les instruccios del guiat, crear piscina nova</p>
<div class="figure">
<img src="imatges/proxmox/disc_pastrougt2.png" style="width:80.0%" alt="" />
<p class="caption">Elegim els discs que volem per a la nova pool</p>
</div>
<p>Seleccionem els discs que volem, els dos nous que acabem d’afegir i que no tenen format, El ada0 no apareix, perquè ja té creada la pool.</p>
<div class="figure">
<img src="imatges/proxmox/disc_pastrougt3.png" style="width:80.0%" alt="" />
<p class="caption">Crea pool nova</p>
</div>
<p>Els passem a la dreta i elegim ratlla (striping) per fer RAID 0, ens apareix un missatge d’advertència dient que no té redundància de dades .. L’acaptem</p>
<div class="figure">
<img src="imatges/proxmox/disc_pastrougt4.png" style="width:80.0%" alt="" />
<p class="caption">Elegim tipus ratlla</p>
</div>
<p>Apareix una altra advertència, l’acceptem, cliquem força</p>
<div class="figure">
<img src="imatges/proxmox/disc_pastrougt5.png" style="width:80.0%" alt="" />
<p class="caption">Forcem la creació RAID 0</p>
</div>
<p>Li donem un nom i acceptem</p>
<div class="figure">
<img src="imatges/proxmox/disc_pastrougt16.png" style="width:80.0%" alt="" />
<p class="caption">Confirmem que estem segurs</p>
</div>
<p>I el crearia.
Apareix una altra pool, còpia de seguretat total, on podem crear Zvol i dades.</p>
<div class="figure">
<img src="imatges/proxmox/nova_pool.png" style="width:80.0%" alt="" />
<p class="caption">Nova pool</p>
</div>
<p>A partir d’aci és com en el cas anterior, pero d’una forma més correcta de fer-ho. La nova pool, és indiferent que siga formada per un sol disc o per dos, en el cas real seria de soles un disc per aquesta pool BackupTotal.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:sheets-option-drag14"></span>
<img src="imatges/proxmox/discPastrhougt.gif" alt="(Pool backup Total)"  />
<p class="caption">
Imatge 6.3: (Pool backup Total)
</p>
</div>
<p>Ja tindriem el tercer SATA per fer alli les còpies de seguretat de tot el sistema.</p>
</div>
<div id="crear-dataset" class="section level3 hasAnchor" number="6.1.8">
<h3><span class="header-section-number">6.1.8</span> Crear dataset<a href="installar-truenass.html#crear-dataset" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Com a exemple, crearem un dataset per a fer les còpies de seguretat de les VM, guardar les ISO dels sistemes a instal·lar, les imatges LCX …</p>
<p>El dataset vindria a ser aproximadament anàleg a un sistema de fitxers muntat estàndard, que podem compartir i on podem crear capetes per a compartir amb NFS, SMB…</p>
<p>Sera la carpeta d’administració que després compartirem en Proxmox on estarà centralitzat tots els fitxers d’imatges..</p>
<p>En storage -&gt; pool, sobre datatruenas que és el disc ada0 (zfspool1), afegim un nou Dataset. El next és el de Nextcloud, explicat en el seu apartat.</p>
<p>ADD -&gt; Add dataset sobre datatruenas</p>
<div class="figure">
<img src="imatges/proxmox/truena_add_pool.png" style="width:80.0%" alt="" />
<p class="caption">Afegir pool d’administració de Proxmox</p>
</div>
<p>En la configuració li donem el nom del recurs, una xicoteta descripció.</p>
<div class="rmdtip">
<p>En el nivell de compressió li donem a off, no té sentit en aquest volum, ja que el que guardarem en ell, ja està comprimit, ÏSO, còpies de seguretat de VM, etc.</p>
</div>
<div class="figure">
<img src="imatges/proxmox/Pool_backup2.png" style="width:80.0%" alt="" />
<p class="caption">Configuracio de la pool</p>
</div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:sheets-option-drag13"></span>
<img src="imatges/proxmox/Afegir_pool_backup.gif" alt="(Crear Dataset)"  />
<p class="caption">
Imatge 6.4: (Crear Dataset)
</p>
</div>
<p>Quedaria compartir-lo en NFS</p>
<div id="crear-zvol" class="section level4 hasAnchor" number="6.1.8.1">
<h4><span class="header-section-number">6.1.8.1</span> Crear Zvol<a href="installar-truenass.html#crear-zvol" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Una altra opcio seria afegir un Zvol, és tipus block, com si ferem un disc real de mida fixa, al que podem fer partricions, LVM .. i formatar les particions que creem en el format que vulguem, EXT4,NTFS …, Pero mante les caracteristique de ZFS, instanatanies, restauracio, control d’errors per a Tuenas.
Al sistema client, seria un disc dur normal, aquest recurs l’hem de compartir, no caom a seveis de xarxa normails, sinó amb iSCSI.</p>
<p>iSCSI és un protocol de xarxa que permet posar els discs durs en una caixa NAS o servidor, però a l’ordinador apareixen com si estaguera connectat localment.</p>
<p>En linux hem de fer una xicoteta configuracio, <a href="https://ubuntu.com/server/docs/service-iscsi">exemple en ubuntu</a>, per al que el detecte, pero a partir d’aci és com un disk normal. Té les seues ventages.</p>
<p>Creem un volum d’aquest tipus dins del dataset Backup, per tindre-ho ordenat, per fer proves, l’unic inconveniesnt és que les VM que es creen aci, no es poden migrar a un altre servidor proxmox en calent.</p>
<p>Per exemple, es poden crear diferents perticions o volums Zvol i asignar cadascuna a un usuari o host, i tindria el seu volum aillat de la resta dels companys.</p>
<div class="rmdtip">
<p>El més recomanat seria fer un volum per a les imatges de les ISO, LXC… i un altre per les còpies de seguretat de les VM del servidor Proxmox1, per si en el futur es fa un cluster, i volem tindre centralitzat les ISO, i, per una altra banda, les còpies de seguretat de les VM de cada Proxmox. Pero farem un sol Zvol de moment.</p>
</div>
<p>Per afegir aquest volum, fem el mateix que abans, pero damunt de backup, i en comptes d’afegir un altre dataset, afegim un Zvol. BackupProxmox1</p>
<p>:::{.rmdwarn data-latex=“{Perill}”
Després en la GUI, Backup ho tradueix per Còpia de seguretat Proxmox1, pero la referència al recurs és BackupProxmox1, igual que nesxt que és la de Nextcloud la tradueix com a proxim. Lia més que ajudar.
:::</p>
<p>Aci li donarem un nom, i la capacitat que hem d’especificar en GiB perquè ho entenga. Podem forçar que es limite al tammany, pero no es recomana, comença a donar problemes quan arriba al 80%.
El nivell de compressió el deixem com està, desactivat.</p>
<div class="figure">
<img src="imatges/proxmox/Zvol_backup.png" style="width:80.0%" alt="" />
<p class="caption">Zvol de Backup per a Prozmox</p>
</div>
<p>El tindriem que compartir com a ISCSI i en proxmox afegir-lo com a ISCSI sobre ZFS</p>
<div class="figure">
<img src="imatges/proxmox/ISCSI_ZFS.png" style="width:50.0%" alt="" />
<p class="caption">ISCSI over ZFS</p>
</div>
<div class="rmdnote">
<p>Tindriem que configurar la comparticio ISCSI, hem de definir portal, bancs, usuari. Queda pendent per provar.</p>
</div>
<p>El cas és que en utilitzar el dataset backup compartit per NFS en proxmox, dins d’ell està el Zvol backupProxmox1 i fer còpies de seguretat de VM i la LXC que hem baixat.</p>
<div class="figure">
<img src="imatges/proxmox/backup_proxmox_VMs.png" style="width:80.0%" alt="" />
<p class="caption">Backup proxmox</p>
</div>
<p>Després en la pool de Truenas, pareix que ha fet les carpetes i guardat les dades dins el Zvol BackupProxmox1, dins de Backup soles està el Zvol</p>
<div class="figure">
<img src="imatges/proxmox/backup_tuenas_vms.png" style="width:80.0%" alt="" />
<p class="caption">Truenas backup</p>
</div>
<p>Pero si editem el recus Backup compartit per NFS estan les carpetes de Proxmox, les definides en afegir-lo, dump per a les còpies de seguretat de les VM, imatges per a les ISO … En l’espai ocupat correcte.</p>
<div class="figure">
<img src="imatges/proxmox/Backup_NFS_edit.png" style="width:80.0%" alt="" />
<p class="caption">Directoris dins de Backup NFS</p>
</div>
<p>En fer la replia posteriorment, es replica el Zvol, no ho tinc encara massa clar el que està pasant.</p>
</div>
<div id="activar-nfs" class="section level4 hasAnchor" number="6.1.8.2">
<h4><span class="header-section-number">6.1.8.2</span> Activar NFS<a href="installar-truenass.html#activar-nfs" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Per activar el protoclo de comparticio, perimer l’hem d’abilitar.</p>
<p>Anem a services, i habilitem la compartició NFS, i marquem el quadre de posar en funcionament en arrancar.</p>
<div class="rmdtip">
<p>Per poder compartir el recurs per xarxa, estan tots protocols per fer-ho, SMB, TFTP… Pero com totes les màquines són Linux, prefereix fer-ho d’aquesta manera. També es podria fer amb iscsi que on la host client es creu que es un disc real. Queda pendent d’investigar el funcionament.</p>
</div>
<div class="figure">
<img src="imatges/proxmox/NFS_up.png" style="width:80.0%" alt="" />
<p class="caption">Encendre NFS</p>
</div>
</div>
<div id="compartir-el-recurs" class="section level4 hasAnchor" number="6.1.8.3">
<h4><span class="header-section-number">6.1.8.3</span> Compartir el recurs<a href="installar-truenass.html#compartir-el-recurs" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>En sharing -&gt; NFS, afegim nou recurs i el configurem.</p>
<p>Primer elegim el directori a compartir, el dataset backup (dins d’aquest tenim el Zvol backupproxmox1) en datatruenas, elegim all dir perquè el client puga elegir el subdirectori que vulga o tots esl que hi haja.
Li donem a opcions avançades, i li donem permisos soles al root per a manipular-lo, i cap altre usuari el pot mapar.</p>
<p>En Networks li diguem la xarxa on estarà disponible, posteriorment el pasarem a la xarxa VLAN 1 172.16.0.0/24 i la IP fixa de proxmox en aquesta xarxa.</p>
<div class="rmdinfo centre">
<p>En un futur, configurarem primer el DNS de pfSense per posar els noms de les màquines i no les IP. D’aquesta forma quan configurem les VLAN, i la d’administració, haurem de tornar a configurar totes les IP o posar ja el nom real de la màquina de totes les configuracions.</p>
</div>
<div class="figure">
<img src="imatges/proxmox/NFS_backup.png" style="width:80.0%" alt="" />
<p class="caption">Comparticio NFS dataset backup</p>
</div>
<p>En proxmox l’afegiriem de la mateixa forma que vam fer en el recurs compartit per el host al principi. L’hem anomenat backup</p>
<div class="figure">
<img src="imatges/proxmox/llista_enma.png" style="width:80.0%" alt="" />
<p class="caption">llista espais emmagatzenament proxmox</p>
</div>
<p>La configuracio en l’apartat de Poxmox.</p>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="truenas.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="politaca-de-volums.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="assets/gitbook-2.6.7/js/app.min.js"></script>
<script src="assets/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="assets/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/incitato/prova/edit/main/06-freenas.rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Arts_Escèniques.pdf", "Arts_Escèniques.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "none"
},
"toolbar": {
"position": "static"
}
});
});
</script>

</body>

</html>
